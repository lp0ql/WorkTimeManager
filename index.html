<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>作業時間</title>
</head>
<body>
    <div id="counter">??:??</div>
    <div id="status">JavaScript待機中</div>
    <div id="reset">リセット</div>
    <style>
        body{
            background-color: yellowgreen;
            color: black;
        }
        #counter{
            position: fixed;
            left: 0%;
            top: 0%;
            width: 100%;
            height: 90%;
            font-size: 5vmin;
            display:flex;
            justify-content: center;
            align-items: center;
        }
        #status{
            position: fixed;
            left: 0%;
            top: 90%;
            width: 100%;
            height: 5%;
            font-size: 5vmin;
            display:flex;
            justify-content: center;
            align-items: center;
        }
        #reset{
            position: fixed;
            right: 1%;
            width: auto;
            font-size: 4vmin;
            border:solid 1px;
            cursor: pointer;
            padding: 0.5%;
            background-color: rgb(127.5,127.5,127.5,0);
            opacity: 0.5;
        }
        #reset:hover{
            background-color: rgb(127.5,127.5,127.5,0.5);
            opacity: 1;
        }
    </style>
    <script>
        let time_settings = {
            break:600,
            work:3000,
            save:300
        };

        function localStorageCheck(data_type){
            if(localStorage[data_type]){
                time_settings[data_type] = Number(localStorage[data_type]);
            }else{
                localStorage[data_type] = String(time_settings[data_type]);
            };
        };

        localStorageCheck("break");
        localStorageCheck("work");
        localStorageCheck("save");



        const elements = {
            counter:document.getElementById("counter"),
            status:document.getElementById("status")
        };

        const coeFontStudio = {
            audios:{
                work:new Audio("./voice/work.wav"),
                save:new Audio("./voice/save.wav"),
                break:new Audio("./voice/break.wav"),
            },
            show:function(){
                const coeFontStudioText = "Voiced by https://CoeFont.studio";
                const beforeText = elements.status.innerText;
                elements.status.innerText = coeFontStudioText;
                setTimeout(function(){
                    if(elements.status.innerText == coeFontStudioText){
                        elements.status.innerText = beforeText;
                    };
                },5000);

            },
            play:function(voice_type){
                coeFontStudio.audios[voice_type].play();
                coeFontStudio.show();
            }
        }

        //カウントを開始
        function counter(s){
            return new Promise((resolve) => {
                //画面に時間を表示
                function display(s){
                    var min = s % 3600 / 60 | 0;
                    var sec = s % 60;
                    //1桁の数字を2桁にする
                    function add_zero(num){
                        num = String(num);
                        if(num.length == 1){
                            num = "0" + num;
                        };
                        return num;
                    };

                    min = add_zero(Math.round(min));
                    sec = add_zero(Math.round(sec));
                    elements.counter.innerText = min + " : " + sec;
                    document.title = elements.counter.innerText + " 　" + elements.status.innerText;
                };
                display(s);

                let start_date = Date.now();

                if(localStorage.start_date){//ローカルストレージにデータがある場合復元
                    start_date = new Date(JSON.parse(localStorage.start_date));
                };

                
                localStorage.start_date = JSON.stringify(start_date);//ローカルストレージにデータを保存

                var interval = setInterval(function(){
                    var elapsed = Math.floor( Math.abs(start_date - Date.now())/1000);
                    if(elapsed>s){
                        clearInterval(interval);
                        delete localStorage.start_date;
                        resolve();
                    };
                    display(s-elapsed);
                },1000);



            })
        };


        function start_break_time(){
            localStorage.process = "start_break_time";
            elements.status.innerText = "休憩時間";

            counter(time_settings.break/2).then(() => {
                main_time();
            })
        };

        function main_time(){
            localStorage.process = "main_time";
            elements.status.innerText = "作業時間";
            document.body.animate([
                {
                    backgroundColor:"black",
                    color:"white"
                }
            ],{
                duration:1000,
                easing:"ease",
                fill:"both"
            });

            counter(time_settings.work).then(() => {
                save_time();
            });
            
            coeFontStudio.play("work");
        };

        function save_time(){
            localStorage.process = "save_time";
            elements.status.innerText = "整理時間";
            document.body.animate([
                {
                    backgroundColor:"darkorange",
                    color:"black"
                }
            ],{
                duration:1000,
                easing:"ease",
                fill:"both"
            });

            counter(time_settings.save).then(() => {
                end_break_time();
            });
            coeFontStudio.play("save");
        };

        function end_break_time(){
            localStorage.process = "end_break_time";

            elements.status.innerText = "休憩時間";
            document.body.animate([
                {
                    backgroundColor:"yellowgreen",
                    color:"black"
                }
            ],{
                duration:1000,
                easing:"ease",
                fill:"both"
            });


            setTimeout(function(){
                delete localStorage.start_date;
                delete localStorage.process;
                window.location.reload();
            },time_settings.break/2*1000);

            
            counter(time_settings.break);

            coeFontStudio.play("break");

        };



        //ローカルに情報があれば続きから、なければ最初から
        (function(){
            const local_process = localStorage.process;

            if(local_process == "main_time"){
                main_time();
            }else if(local_process == "save_time"){
                save_time();
            }else if(local_process == "end_break_time"){
                end_break_time();
            }else{
                start_break_time();
            };
        })();


        //ブラウザの音声再生許可表示用
        (function(){
            new Audio("./voice/test.wav").play();
        })();


        //リセットの処理
        (function(){
            document.getElementById("reset").onclick = function(){
                const reset_element = document.getElementById("reset");
                reset_element.innerText = "トリプルクリックでリセット";
                setTimeout(function(){
                    reset_element.innerText = "リセット";
                },5000);

                if(reset_element.dataset.click && reset_element.dataset.click == "2"){
                    delete localStorage.process;
                    delete localStorage.start_date;
                    window.location.reload();
                }else{
                    var now = reset_element.dataset.click;
                    if(!now){
                        now = "0";
                    };
                    now = Number(now) + 1;
                    reset_element.dataset.click = String(now);

                    setTimeout(function(){
                        reset_element.dataset.click = "0";
                    },1000);

                }

            }
        })()





    </script>
</body>
</html>